@page "/admin"
@rendermode InteractiveServer
@using EmployeeTimeClock.Web.Ports
@using EmployeeTimeClock.Web.State
@using EmployeeTimeClock.Web.Domain.Entities
@inject SessionState Session
@inject IAuthService AuthService
@inject ITimeClockService Clock
@inject NavigationManager Nav

<div class="admin-container">
    <h2>Administrator Console</h2>

    @if (!Session.IsLoggedIn || Session.CurrentUser is null)
    {
        <div class="alert alert-warning">
            You are not logged in.
        </div>
        <button class="btn btn-primary" @onclick="GoToLogin">Go to Login</button>
    }
    else if (!Session.IsAdmin)
    {
        <div class="alert alert-danger">
            <strong>Access Denied</strong> ‚Äî Only administrators can access this page.
        </div>
        <button class="btn btn-secondary" @onclick="GoToDashboard">Return to Dashboard</button>
    }
    else
    {
        <div class="admin-welcome">
            <p>Logged in as: <strong>@Session.CurrentUser.DisplayName</strong> (Admin)</p>
        </div>

        <div class="admin-tabs">
            <button
                class="tab-button @(activeTab == "users" ? "active" : "")"
                @onclick="@(() => SwitchTab("users"))">
                üë• Users
            </button>
            <button
                class="tab-button @(activeTab == "timeentries" ? "active" : "")"
                @onclick="@(() => SwitchTab("timeentries"))">
                ‚è±Ô∏è All Time Entries
            </button>
        </div>

        @if (activeTab == "users")
        {
            <div class="admin-section">
                <h3>User Management</h3>
                
                @if (users == null)
                {
                    <div class="alert alert-info">
                        <span class="spinner-border spinner-border-sm me-2"></span> Loading users...
                    </div>
                }
                else if (users.Count == 0)
                {
                    <div class="alert alert-warning">No users found.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Display Name</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in users)
                                {
                                    <tr>
                                        <td>@user.Id</td>
                                        <td><code>@user.Username</code></td>
                                        <td>@user.DisplayName</td>
                                        <td>
                                            <span class="badge @(user.Role == "Admin" ? "bg-danger" : "bg-info")">
                                                @user.Role
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }

        @if (activeTab == "timeentries")
        {
            <div class="admin-section">
                <h3>All Time Entries</h3>
                
                <div class="filter-controls">
                    <div class="control-group">
                        <label for="adminStartDate">From Date:</label>
                        <input type="date" id="adminStartDate" class="form-control" @bind="adminStartDate" />
                    </div>
                    <div class="control-group">
                        <label for="adminEndDate">To Date:</label>
                        <input type="date" id="adminEndDate" class="form-control" @bind="adminEndDate" />
                    </div>
                    <div class="control-group">
                        <button class="btn btn-primary" @onclick="LoadAllTimeEntries">
                            <span class="oi oi-magnifying-glass"></span> Load Entries
                        </button>
                    </div>
                </div>

                @if (isLoadingEntries)
                {
                    <div class="alert alert-info">
                        <span class="spinner-border spinner-border-sm me-2"></span> Loading time entries...
                    </div>
                }
                else if (allTimeEntries == null)
                {
                    <div class="alert alert-info">
                        Click "Load Entries" to view time entries.
                    </div>
                }
                else if (allTimeEntries.Count == 0)
                {
                    <div class="alert alert-warning">
                        No time entries found for the selected date range.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>User ID</th>
                                    <th>Date</th>
                                    <th>Clock In</th>
                                    <th>Clock Out</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in allTimeEntries)
                                {
                                    <tr>
                                        <td>
                                            <strong>@entry.UserId</strong>
                                        </td>
                                        <td>@entry.ClockIn:d</td>
                                        <td>@entry.ClockIn:t</td>
                                        <td>@(entry.ClockOut?.ToString("t") ?? "-")</td>
                                        <td>
                                            @if (entry.DurationMinutes > 0)
                                            {
                                                var hrs = entry.DurationMinutes / 60;
                                                var mins = entry.DurationMinutes % 60;
                                                <span>@hrs:@mins.ToString("D2")</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Active</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="admin-summary">
                        <p><strong>Total Entries:</strong> @allTimeEntries.Count</p>
                        <p><strong>Total Minutes Logged:</strong> @totalMinutesLogged</p>
                        <p><strong>Average Per Entry:</strong> @(allTimeEntries.Count > 0 ? (totalMinutesLogged / allTimeEntries.Count) : 0) min</p>
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .admin-welcome {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .admin-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
        background: none;
        border: none;
        padding: 1rem 1.5rem;
        font-size: 1em;
        cursor: pointer;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }

    .tab-button:hover {
        color: #333;
    }

    .tab-button.active {
        color: #667eea;
        border-bottom-color: #667eea;
        font-weight: 600;
    }

    .admin-section {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }

    .admin-section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 1rem;
    }

    .filter-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .control-group label {
        font-weight: 600;
        color: #333;
        font-size: 0.95em;
    }

    .control-group input,
    .control-group .btn {
        min-width: 150px;
    }

    .table-responsive {
        overflow-x: auto;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead {
        background-color: #2c3e50;
    }

    .table tbody tr {
        border-bottom: 1px solid #e0e0e0;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
    }

    .badge {
        padding: 0.35em 0.65em;
        font-size: 0.85em;
    }

    .admin-summary {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .admin-summary p {
        margin: 0.5rem 0;
        color: #555;
    }

    @@media (max-width: 768px) {
        .filter-controls {
            flex-direction: column;
        }

        .control-group input,
        .control-group .btn {
            min-width: 100%;
        }

        .admin-tabs {
            flex-direction: column;
        }

        .tab-button {
            padding: 0.75rem 1rem;
            border-bottom: none;
            border-left: 3px solid transparent;
        }

        .tab-button.active {
            border-bottom: none;
            border-left-color: #667eea;
        }

        .admin-container {
            padding: 1rem 0.5rem;
        }

        .admin-section {
            padding: 1.5rem;
        }
    }
</style>

@code {
    private string activeTab = "users";
    private IReadOnlyList<UserAccount>? users;
    private IReadOnlyList<TimeEntry>? allTimeEntries;
    private DateTime adminStartDate;
    private DateTime adminEndDate;
    private bool isLoadingEntries = false;

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsLoggedIn || !Session.IsAdmin)
        {
            Nav.NavigateTo("/dashboard", replace: true);
            return;
        }

        // Load users on init
        await LoadUsers();

        // Default date range
        adminEndDate = DateTime.Now.Date;
        adminStartDate = adminEndDate.AddDays(-30);
    }

    private void GoToLogin() => Nav.NavigateTo("/login", replace: true);
    private void GoToDashboard() => Nav.NavigateTo("/dashboard", replace: true);

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task LoadUsers()
    {
        users = await AuthService.GetAllUsersAsync();
    }

    private async Task LoadAllTimeEntries()
    {
        if (adminStartDate > adminEndDate)
        {
            var temp = adminStartDate;
            adminStartDate = adminEndDate;
            adminEndDate = temp;
        }

        isLoadingEntries = true;
        try
        {
            // For now, we'll load entries for each user
            // In a real app, the service would have a method to get all entries
            var allUsers = await AuthService.GetAllUsersAsync();
            var entries = new List<TimeEntry>();

            foreach (var user in allUsers)
            {
                var userEntries = await Clock.GetEntriesAsync(user.Id, adminStartDate, adminEndDate.AddDays(1));
                entries.AddRange(userEntries);
            }

            allTimeEntries = entries.OrderByDescending(e => e.ClockIn).ToList().AsReadOnly();
        }
        finally
        {
            isLoadingEntries = false;
        }
    }

    private int totalMinutesLogged => allTimeEntries?.Sum(e => e.DurationMinutes) ?? 0;
}
